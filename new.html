<!doctype html>
<html>
    <head>

        <title>jsPlumb - flowchart demonstration</title>
        <meta http-equiv="content-type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" />

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

        <style>

            .canvas {
                resize: both;
                overflow: scroll !important;
                background-color: #3b3b3b;
                height: 600px;
                display: flex;
                position:relative;
            }

            .canvas ul{
                display: flex;
                position: absolute;
                min-width: 300px;
            }

            .canvas svg{
                stroke: #000;
            }

            .canvas svg path:hover{
                stroke: red !important;
            }

            .canvas svg circle:not(.origin){
                stroke: yellow;
                cursor: pointer;
            }
        </style>

    </head>

    <body>

        <div>
            <div class="canvas" id="canvas" > </div>
        </div>

        <input id='connect' type='checkbox' />
        <button id='save'> Save </button>
        <article>
            <h3>ToDo List</h3>
            <p> <input type='checkbox' /> Table moviment needs to guet relative position, not ablolute while dragging, this is visible while moving blocks to the page border </p>
            <p> <input type='checkbox' /> Create SVG lines between the two tables being connected <p>
            <p> <input type='checkbox' /> Create SVG dots relative to the tables <p>
            <p> <input type='checkbox' /> Update lines and dots between two tables <p>
        </article>

        <script src='data.js'></script>
        <script src='src/databaseJs.js'></script>

        <script>
            $('.canvas').databaseJs();
        </script>

        <script>

            var dragging = false;
            var dragStep = 20;
            var startOffsetX = 0;
            var startOffsetY = 0;
            var dragElement = null;

            $('.canvas').on('mousedown', 'ul > li:first-of-type', function(e){
                e.preventDefault();
                dragging = true;
                dragElement = e.currentTarget;
            });

            $('html').on('mouseup', function(e){
                e.preventDefault();
                dragElement = null; 
                dragging = false;
                pointInDrag = null; //SVG
                pointDragging = false; //SVG
            });

            $('.canvas').on('mousemove', function(e){
                if(dragging){
                    var newx = e.currentTarget.scrollLeft + e.originalEvent.clientX; 
                    var newy = e.currentTarget.scrollTop + e.originalEvent.clientY;

                    if( newx - startOffsetX > dragStep || Math.abs(startOffsetX - newx) > dragStep ){
                        startOffsetX = newx; 
                        $(dragElement).parent().css('left', newx ).trigger('move');
                        //$(dragElement).parent().find('li').each(function(i, j){ $(j).trigger('move', {});  })
                    }
                    if( newy - startOffsetY > dragStep || Math.abs(startOffsetY - newy) > dragStep ){
                        startOffsetY = newy; 
                        $(dragElement).parent().css('top', newy ).trigger('move'); 
                        //$(dragElement).parent().find('li').each(function(i, j){ $(j).trigger('move', {});  })
                    }
                }
                if(pointDragging){ //SVG
                    $(pointInDrag).attr('cx', e.originalEvent.clientX - $(pointInDrag).parent().parent().position().left );
                    $(pointInDrag).attr('cy', e.originalEvent.clientY - $(pointInDrag).parent().parent().position().top );
                    $(pointInDrag).parent().parent().trigger('change');
                }
            });

            // ###################################################
            //https://www.w3schools.com/graphics/svg_path.asp
            var creatingPath = false;
            var originTable = null;
            var pointDragging = false;
            var pointInDrag = null;

            $('.canvas ul').on('click', function(e){
                if(creatingPath == false){ return; }
                if(originTable == null){
                    originTable = e.currentTarget;
                }else if( $(e.currentTarget).parent() ){
                    createPath(originTable, e.currentTarget);
                    originTable = null;
                    creatingPath = false;
                    $('#connect').prop('checked', false);
                }
            });

            /*$('.canvas li').on('move', function(e){
                console.log(e);
            });*/

            $('.canvas').on('change', 'svg', function(){
                recalculatePaths($(this));
            });
            
            $('.canvas').on('dblclick', 'path', function(e){
                alert('connection');
            });
           
            //Start moving dot wich is not on the origin
            $('.canvas').on('mousedown', 'circle:not(.origin)', function(){
                pointInDrag = $(this);
                pointDragging = true;
            });

            // Table element moving. Search and move child dot
            $('.canvas').on('move', 'ul', function() {
                var table = '[data-table="'+$(this).attr('id')+'"]';
                var element = $('svg g ' + table );
                
                var svg = $(element).parent().parent();
                
                if( svg.length == 0 ){ return; }

                var top = parseFloat( $(svg).css('top').replace('px', '') )
                var left = parseFloat( $(svg).css('left').replace('px', '') )

                var x = ( $(this).position().left + $(this).width() / 2) - left;
                var y = ( $(this).position().top  + $(this).height() / 2) - top;
                
                $(element).attr('cx', ( $(this).position().left + $(this).width() / 2) - left );
                $(element).attr('cy',  ( $(this).position().top  + $(this).height() / 2) - top );

                recalculateSVG(svg);
                recalculatePaths(svg);
            });

            $('#connect').on('change', function(){
                if (creatingPath){
                    creatingPath = false;
                }else{
                    creatingPath = true;
                }
            });

            $('.canvas').on('change', 'svg', function(){
                console.log(  );
            });

            function createPath(element1, element2) {
                var fieldName = prompt('Table name', $(element1).attr('id') + "id"); 
                if(fieldName == null || fieldName == ''){ return; }

                var svg = createSVG(element1, element2, 'id', fieldName)
                recalculateSVG(svg);
                createDots(element1, element2, svg)
                recalculatePaths(svg) 
            }
            
            function createSVG(element1, element2, originField, targetField){
                var dataFields = "";
                dataFields += "data-origintable='"+$(element1).attr('id')+"'";
                dataFields += "data-targettable='"+$(element2).attr('id')+"'";
                dataFields += "data-originfield='"+originField+"'";
                dataFields += "data-targetfield='"+targetField+"'";

                var svg = "<svg "+dataFields+" > <g class='lines'></g> <g class='dots'></g>  </svg>";
                $('.canvas').html( $('.canvas').html() + svg );
                return $('[data-origintable="'+$(element1).attr('id')+'"][data-targettable="'+$(element2).attr('id')+'"][data-originfield="'+originField+'"][data-targetfield="'+targetField+'"]');
            }

            function createDots( element1, element2, svg ){
                //Somehow, this stoped working, so search elements by id. No sense, but it needs
                element1 = $('#'+$(element1).attr('id'));
                element2 = $('#'+$(element2).attr('id'));

                var x1 = ( $(element1).position().left + $(element1).width() / 2) - parseFloat( $(svg).css('left').replace('px', '') ) 
                var y1 = ( $(element1).position().top  + $(element1).height() / 2) - parseFloat( $(svg).css('top').replace('px', '') )
                
                var x2 = ( $(element2).position().left + $(element2).width() / 2 ) - parseFloat( $(svg).css('left').replace('px', '') )
                var y2 = ( $(element2).position().top  + $(element2).height() / 2 ) - parseFloat( $(svg).css('top').replace('px', '') )

                var offsetTop = $(element1).height() / 2;
                var offsetLeft = $(element1).width() / 2;

                var points = "";
                points += "<circle class='origin' cx='"+x1+"' cy='"+y1+"' r='3' data-table='"+$(element1).attr('id')+"' />";
                points += "<circle cx='"+(Math.abs(x1-x2) - offsetLeft)+"' cy='"+( Math.abs(y1-y2) + offsetTop )+"' r='3' />";
                points += "<circle class='origin' cx='"+x2+"' cy='"+y2+"' r='3' data-table='"+$(element2).attr('id')+"' />";
                $(svg).find('.dots').html(points);
            }

            /*
            *
            * @return Array(width, height, left, top)
            */
            function calculateSVGSize(element1, element2){
                var rel = null; // Right element
                var lel = null; // Left element
                if( $(element1).position().left + $(element1).width() > $(element2).position().left + $(element2).width() ){
                    rel = element1; 
                }else{
                    rel = element2;
                }
                if( $(element1).position().left < $(element2).position().left ){
                    lel = element1; 
                }else{
                    lel = element2; 
                }

                var tel = null; // Top element
                var bel = null; // Bottom element
                if($(element1).position().top < $(element2).position().top ){
                    tel = element1;
                }else{
                    tel = element2;
                }
                
                if( $(element1).position().top + $(element1).height() > $(element2).position().top + $(element2).height() ){
                    bel = element1;
                }else{
                    bel = element2;
                }

                return {
                    "width" : $(rel).position().left + $(rel).width() ,
                    "height" : $(bel).position().top + $(bel).height(),
                    "left" : $(lel).position().left,
                    "top" : $(tel).position().top,
                };
            }

            function recalculateSVG(svg){
                var element1 = $('#'+$(svg).data('origintable') )
                var element2 = $('#'+$(svg).data('targettable') )
                var dimensions = calculateSVGSize(element1, element2);
                
                $(svg).attr('width', dimensions.width );
                $(svg).attr('height', dimensions.height );

                $(svg).css('top', dimensions.top );
                $(svg).css('left', dimensions.left );
                $(svg).css('position', 'absolute');
            }

            function createLine(){
                return "<path d='M 250 50 l 150 1300' stroke-width='3' />"
            }

            function recalculatePaths(svg){
                var lines = '';
                var oldElement = null;
                $(svg).find('circle').each(function(i, el){
                    if(oldElement == null){ oldElement = el; return;  }
                    var x1 = $(oldElement).attr('cx') //- parseFloat( $(svg).css('left').replace('px', '') ) 
                    var y1 = $(oldElement).attr('cy') //- parseFloat( $(svg).css('top').replace('px', '') )
                    var x2 = $(el).attr('cx') - parseFloat( $(svg).css('left').replace('px', '') ) 
                    var y2 = $(el).attr('cy') - parseFloat( $(svg).css('top').replace('px', '') ) 
                    lines += "<path d='M "+x1+" "+y1+" l "+x2+" "+y2+"' stroke-width='3' />"
                    oldElement = el;
                }); 
                $(svg).find('.lines').html(lines);
            }

            function movePath(){
                
            }

            //#################################################

            $('#save').on('click', function(){
                var tables = {'tables' : [] };
                $('.canvas ul').each(function (i, el){
                    var table = {};
                    table.name = $(el).attr('id');
                    table.left = parseFloat( $(el).css('left').replace('px', '') )
                    table.top  = parseFloat( $(el).css('top').replace('px', '') ) 
                    $(el).find('li').each(function(j, inel){
                        
                    })
                    tables.tables.push(table)
                });
                console.log(tables)
            })

        </script>

    </body>
</html>
